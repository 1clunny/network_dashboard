{% extends "layout.html" %}
{% block content %}

<div class="flex flex-col gap-6">
  <!-- Animated Network -->
  <div class="bg-gray-900/60 backdrop-blur-xl rounded-2xl border border-gray-800 p-6 relative overflow-hidden">
    <h2 class="text-lg font-semibold text-accent mb-4">Animated Network Map</h2>
    <canvas id="animatedCanvas" class="w-full h-[400px] rounded-2xl bg-gray-950"></canvas>
  </div>

  <!-- Device List -->
  <div class="bg-gray-900/70 backdrop-blur-xl rounded-2xl border border-gray-800 p-6">
    <h2 class="text-lg font-semibold text-accent mb-4">Device Overview</h2>
    <div id="deviceList" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-gray-300">
      <!-- Device buttons will go here -->
    </div>
  </div>

  <!-- Sidebar Info -->
  <div class="w-full bg-gray-900/70 backdrop-blur-xl rounded-2xl border border-gray-800 p-6">
    <h3 class="text-accent font-semibold mb-4">Device Info</h3>
    <div id="deviceInfo" class="text-gray-400 space-y-2">
      <p>Select a device on the map or from the list ðŸ‘‡</p>
    </div>
  </div>
</div>

<script>
const canvas = document.getElementById("animatedCanvas");
const ctx = canvas.getContext("2d");
const infoBox = document.getElementById("deviceInfo");
const deviceListContainer = document.getElementById("deviceList");

// Devices
const devices = [
  { name: "Router", x: 300, y: 150, dx: 0.25, dy: 0.2, color: "#00C6FF", info: "Main Gateway â€¢ 192.168.1.1" },
  { name: "Laptop", x: 150, y: 300, dx: -0.2, dy: 0.18, color: "#22c55e", info: "Laptop â€¢ 192.168.1.23" },
  { name: "Phone", x: 480, y: 320, dx: 0.22, dy: -0.25, color: "#facc15", info: "Smartphone â€¢ 192.168.1.45" },
  { name: "Camera", x: 420, y: 100, dx: -0.18, dy: 0.2, color: "#ef4444", info: "Security Cam â€¢ 192.168.1.55" },
];

const links = [
  [0,1],[0,2],[0,3]
];

let selected = null;
let clickEffects = [];

// Make canvas responsive
function resizeCanvas() {
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

// Draw a single device
function drawDevice(ctx, device, radius = 10, glow = true) {
  if(glow){
    const gradient = ctx.createRadialGradient(device.x, device.y, 3, device.x, device.y, radius*2);
    gradient.addColorStop(0, device.color);
    gradient.addColorStop(1, "transparent");
    ctx.fillStyle = gradient;
  } else {
    ctx.fillStyle = device.color;
  }
  ctx.beginPath();
  ctx.arc(device.x, device.y, radius, 0, Math.PI*2);
  ctx.fill();

  ctx.fillStyle = "#94a3b8";
  ctx.font = "12px Inter, sans-serif";
  ctx.textAlign = "center";
  ctx.fillText(device.name, device.x, device.y + radius + 12);
}

// Draw animated network
function drawAnimated() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Lines
  for(const [a,b] of links){
    const d1 = devices[a], d2 = devices[b];
    const gradient = ctx.createLinearGradient(d1.x,d1.y,d2.x,d2.y);
    gradient.addColorStop(0,"rgba(0,198,255,0.25)");
    gradient.addColorStop(1,"rgba(0,198,255,0.05)");
    ctx.strokeStyle = gradient;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(d1.x,d1.y);
    ctx.lineTo(d2.x,d2.y);
    ctx.stroke();
  }

  // Move & draw devices
  for(const device of devices){
    device.x += device.dx;
    device.y += device.dy;

    if(device.x < 15 || device.x > canvas.width - 15) device.dx *= -1;
    if(device.y < 15 || device.y > canvas.height - 15) device.dy *= -1;

    drawDevice(ctx, device, 10);
  }

  // Click effects
  for(let i=clickEffects.length-1;i>=0;i--){
    const e = clickEffects[i];
    ctx.beginPath();
    ctx.strokeStyle = e.color+"88";
    ctx.lineWidth = 2;
    ctx.arc(e.x,e.y,e.radius,0,Math.PI*2);
    ctx.stroke();
    e.radius += 2;
    e.opacity -= 0.02;
    if(e.opacity<=0) clickEffects.splice(i,1);
  }

  requestAnimationFrame(drawAnimated);
}

// Click handler for canvas
canvas.addEventListener("click",(e)=>{
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;

  for(const device of devices){
    const dx = mouseX - device.x, dy = mouseY - device.y;
    if(Math.sqrt(dx*dx + dy*dy) < 12){
      selected = device;
      infoBox.innerHTML = `<p><strong>${device.name}</strong></p><p>${device.info}</p>`;
      clickEffects.push({x:device.x, y:device.y, radius:10, color:device.color, opacity:1});
      break;
    }
  }
});

// Build static device list
function buildDeviceList(){
  deviceListContainer.innerHTML = "";
  devices.forEach((d,i)=>{
    const btn = document.createElement("button");
    btn.className = "bg-gray-800 hover:bg-gray-700 rounded-lg p-2 text-left cursor-pointer transition-colors";
    btn.innerHTML = `<span class="font-semibold">${d.name}</span><br><span class="text-sm text-gray-400">${d.info}</span>`;
    btn.addEventListener("click",()=>{
      selected=d;
      infoBox.innerHTML = `<p><strong>${d.name}</strong></p><p>${d.info}</p>`;
      clickEffects.push({x:d.x, y:d.y, radius:10, color:d.color, opacity:1});
    });
    deviceListContainer.appendChild(btn);
  });
}

buildDeviceList();
drawAnimated();
</script>

{% endblock %}