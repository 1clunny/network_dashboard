{% extends "layout.html" %}
{% block content %}

<div class="flex flex-col gap-6 min-h-[60vh]">
  <div class="flex items-center justify-between">
    <h2 class="text-lg font-semibold text-accent">Available Wi‑Fi Networks</h2>
    <div class="flex items-center gap-3">
      <button id="rescanBtn" class="px-4 py-2 bg-accent text-black rounded-lg shadow-glow hover:opacity-95 transition">Rescan</button>
      <span id="scanSource" class="text-sm text-gray-400"></span>
    </div>
  </div>

  <div id="networksGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
  </div>

  <div class="bg-white/90 dark:bg-gray-900/60 backdrop-blur-xl rounded-2xl border border-gray-200 dark:border-gray-800 p-4 mt-4">
    <h3 class="text-accent font-semibold mb-2">Network Details</h3>
    <div id="networkDetails" class="text-gray-700 dark:text-gray-300">Select a network to see details</div>
  </div>
</div>

<script>
async function fetchNetworks() {
  const elSource = document.getElementById('scanSource');
  const grid = document.getElementById('networksGrid');
  grid.innerHTML = `<div class="col-span-full py-6 text-center text-gray-400">Scanning…</div>`;
  try {
    const res = await fetch('/api/wifi_scan');
    const j = await res.json();
    if (j.error) {
      grid.innerHTML = `<div class="col-span-full py-6 text-center text-red-400">${j.error}</div>`;
      elSource.textContent = 'error';
      return;
    }
    elSource.textContent = j.source === 'netsh' ? 'scanned from system' : 'demo data';
    renderNetworks(j.networks || []);
  } catch (e) {
    grid.innerHTML = `<div class="col-span-full py-6 text-center text-red-400">Scan failed</div>`;
    console.error(e);
  }
}

function signalBars(percent) {
  const bars = 4;
  const count = Math.round((percent/100) * bars);
  let html = '<div class="flex items-center gap-1">';
  for (let i=1;i<=bars;i++) {
    const h = 6 + i*4;
    const cls = i<=count ? 'bg-accent' : 'bg-gray-700 dark:bg-gray-300/30';
    html += `<div style=\"height:${h}px;width:6px;border-radius:2px;\" class=\"${cls}\"></div>`;
  }
  html += '</div>';
  return html;
}

function renderNetworks(list) {
  const grid = document.getElementById('networksGrid');
  if (!list.length) {
    grid.innerHTML = `<div class="col-span-full py-6 text-center text-gray-400">No networks found</div>`;
    return;
  }
  const q = (document.getElementById('globalSearch')?.value || '').toLowerCase();
  grid.innerHTML = '';
  list.forEach(n => {
    const name = n.ssid || '<hidden>';
    const bssid = n.bssid || '';
    const safeName = name === '' ? '<hidden>' : name;
    const signal = typeof n.signal === 'number' ? n.signal : 0;
    const sec = (n.auth || 'Unknown') + (n.encryption ? ` • ${n.encryption}` : '');
    const card = document.createElement('div');
    card.className = 'p-4 rounded-xl backdrop-blur-xl border border-gray-300/40 bg-white-900/50 hover:shadow-glow cursor-pointer transition';
    card.innerHTML = `
      <div class=\"flex items-start justify-between gap-3\"> 
        <div class=\"flex-1\"> 
          <h4 class=\"font-semibold text-gray truncate\">${safeName}</h4>
          <p class=\"text-sm text-gray-400 mt-1 truncate\">${sec}</p>
          <p class=\"text-xs text-gray-400 mt-2\">Channel: ${n.channel || '-'} • BSSID: ${bssid || '-'} • ${n.radio || ''}</p>
        </div>
        <div class=\"flex flex-col items-end gap-2\"> 
          <div class=\"w-14\">${signalBars(signal)}</div>
          <div class=\"text-sm text-gray-400\">${signal}%</div>
        </div>
      </div>
    `;
    card.addEventListener('click', () => showNetworkDetails(n));
    const matches = (safeName + ' ' + (bssid || '') + ' ' + (n.radio||'')).toLowerCase().includes(q);
    if (q && !matches) card.style.display = 'none';
    grid.appendChild(card);
  });
}

function showNetworkDetails(n) {
  const el = document.getElementById('networkDetails');
  el.innerHTML = `
    <h4 class=\"text-gray-900 dark:text-white font-semibold\">${n.ssid || '<hidden>'}</h4>
    <p class=\"text-sm text-gray-700 dark:text-gray-300 mt-2\">BSSID: <span class=\"font-medium\">${n.bssid || '-'}</span></p>
    <p class=\"text-sm text-gray-700 dark:text-gray-300\">Signal: <span class=\"font-medium\">${n.signal || 0}%</span></p>
    <p class=\"text-sm text-gray-700 dark:text-gray-300\">Channel: <span class=\"font-medium\">${n.channel || '-'}</span></p>
    <p class=\"text-sm text-gray-700 dark:text-gray-300\">Security: <span class=\"font-medium\">${n.auth || 'Unknown'}</span></p>
  `;
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('rescanBtn').addEventListener('click', fetchNetworks);
  fetchNetworks();
});

document.addEventListener('globalSearch', (e) => {
  const q = (e && e.detail && e.detail.query) ? e.detail.query.trim().toLowerCase() : '';
  fetchNetworks();
});

</script>

{% endblock %}